
\writestatus{loading}{Go/WeiQi/Baduk Lua module}


\startluacode

EMPTY = 0
BLACK = 1
WHITE = 2

Board = { Size = 19, LastColor = WHITE, MoveNumber = 0, {}, Label = {}}

Big = { Board = 15, Grid = 0.7, Stone = 14.5, Label = 0.9 }		--> Big sized goban 
Medium = { Board = 12, Grid = 0.5, Stone = 11.5, Label = 0.7 }	--> Medium sized goban
Small = { Board = 10, Grid = 0.4, Stone = 9.5, Label = 0.55 }	 	--> Small sized goban

Unit = Medium

Hoshi19 = {{x=4, y=4}, {x=4, y=10}, {x=4, y=16}, {x=10, y=4}, {x=10, y=10}, {x=10, y=16}, {x=16, y=4}, {x=16, y=10},{x=16, y=16}}
Hoshi13 = {{x=4, y=4}, {x=4, y=10}, {x=10, y=4}, {x=10, y=10}, {x=7, y=7}}
Hoshi9 = {{x=3, y=3}, {x=3, y=7}, {x=7, y=3}, {x=7, y=7}, {x=5, y=5}}

Hoshi = Hoshi19


function stone (x, y, c)	--> x, y: number; c: string (color: white or black)
	tex.sprint("fill fullcircle scaled " .. Unit.Stone .. " shifted (" .. x*Unit.Board .. "," .. y*Unit.Board .. ") withcolor " .. c .. " ;")
	tex.sprint("draw fullcircle scaled " .. Unit.Stone .. " shifted (" .. x*Unit.Board .. "," .. y*Unit.Board .. ") withcolor black ;")
end


function circlemarker (x, y, c)
	tex.sprint("draw fullcircle scaled " .. 0.6*Unit.Stone .. " shifted (" .. x*Unit.Board .. "," .. y*Unit.Board .. ") withpen pencircle scaled (" .. 2*Unit.Grid .. ") withcolor " .. c .. " ;")
end


function label (l, x, y, c)
	tex.sprint("label(textext(\"\\color[" .. c .. "]{\\ss " .. l .. "}\"),(" .. x*Unit.Board .. ',' .. y*Unit.Board .. '))  ;')
end


function draw_goban ()
	for i=1, Board.Size do
		tex.sprint("draw (" .. Unit.Board .. "," .. i*Unit.Board .. ") -- (" .. Board.Size*Unit.Board .. "," .. i*Unit.Board .. ") withpen pencircle scaled " .. Unit.Grid .. " ;")
		tex.sprint("draw (" .. i*Unit.Board .. "," .. Unit.Board .. ") -- (" .. i*Unit.Board .. "," .. Board.Size*Unit.Board .. ") withpen pencircle scaled " .. Unit.Grid .. " ;")
	end

	tex.sprint("draw (" .. Unit.Board .. "," .. Unit.Board .. ") -- (" .. Board.Size*Unit.Board .. "," .. Unit.Board ..") -- (" .. Board.Size*Unit.Board .. "," .. Board.Size*Unit.Board .. ") -- (" .. Unit.Board .. "," .. Board.Size*Unit.Board .. ") -- cycle withpen pencircle scaled (" ..2.5*Unit.Grid .. ") ;")

	for i=1, #Hoshi do
		x = Hoshi[i].x; y = Hoshi[i].y
		tex.sprint("drawdot (" .. x*Unit.Board .. "," .. y*Unit.Board .. ") withpen pencircle scaled (" .. 5*Unit.Grid .. ") ;")
	end
end


function draw_stones ()
--	tex.sprint("defaultfont := \"ss\" ;") 			--> better will be to use Helvetica from TeX Gyre
	tex.sprint("defaultscale := " .. Unit.Label .. " ;")

	local index
	for i=1, Board.Size do
		for j=1, Board.Size do
			index = i*Board.Size+j
			if Board[index] == BLACK then stone(i, j, "black") elseif Board[index] == WHITE then stone(i, j, "white") end
			if Board.Label[index] > 0 then
				if Board[index] == BLACK then
					label(Board.Label[index], i, j, "white")
				elseif Board[index] == WHITE then
					label(Board.Label[index], i, j, "black")
				end
			elseif Board.Label[index] < 0 then
				if Board[index] == BLACK then circlemarker(i, j, "white") else circlemarker(i, j, "black") end
			end
		end
	end
end


function display_board(name, size, p1, p2)
	tex.sprint("\\startuseMPgraphic{" .. name .. "}{}")
	tex.sprint("path p ;")

	draw_goban()
	draw_stones()

	if p1 then
		local x1, y1 = Point(p1)
		local x2, y2 = Point(p2)
		tex.sprint("p:= (" .. (x1-1)*Unit.Board .. "," .. (y1-1)*Unit.Board ..") -- (" .. x2*Unit.Board .. "," .. (y1-1)*Unit.Board .. ") -- (" .. x2*Unit.Board .. "," .. y2*Unit.Board .. ") -- (" .. (x1-1)*Unit.Board .. "," .. y2*Unit.Board .. ") -- cycle ;")
		tex.sprint("clip currentpicture to p shifted (" .. Unit.Board/2 .. "," .. Unit.Board/2 .. ") ;")
	end

	tex.sprint("\\stopuseMPgraphic")
	tex.sprint("\\useMPgraphic{" .. name .. "}")
end


function set_stone (p, c)		--> c = "black", "white" or "empty" (AB, AW, AE)
	local x, y = Point(p)
	if c == "black" then
		Board[x*Board.Size+y] = BLACK 
	elseif c == "white" then
		Board[x*Board.Size+y] = WHITE
	elseif c == "empty" then
		Board[x*Board.Size+y] = EMPTY
	end
end


function Point (p)
	local x, y = 0, 0
	local l = "abcdefghijklmnopqrstuvwxyz"
	x = string.find(l, string.sub(p, 1, 1))
	y = string.find(l, string.sub(p, 2, 2))
	return x, y
end


function set_marker (p)
	local x, y = Point(p)
	if Board[x*Board.Size+y] > 0 then Board.Label[x*Board.Size+y] = -1 end
end


function play_move (p, c)		--> if p not defined -> pass
	Board.MoveNumber = Board.MoveNumber + 1	
	if c then
		if c == "white" then Board.LastColor = WHITE else Board.LastColor = BLACK end
	else
		if Board.LastColor == BLACK then Board.LastColor = WHITE else Board.LastColor = BLACK end
	end
	if p then
		local x, y = Point(p)
		Board[x*Board.Size+y] = Board.LastColor
		Board.Label[x*Board.Size+y] = Board.MoveNumber
	end
end


function reset_board (s)
	if s == "small" then
		Board.Size = 9
		Hoshi = Hoshi9
	elseif s == "medium" then
		Board.Size = 13
		Hoshi=Hoshi13
	else
		Board.Size = 19
		Hoshi = Hoshi19
	end
	Board.LastColor = WHITE
	Board.MoveNumber = 0
	for i=1, Board.Size do
		for j=1, Board.Size do
			Board[i*Board.Size+j] = 0; Board.Label[i*Board.Size+j] = 0
		end
	end
end


function reset_labels ()
	Board.MoveNumber = 0
	for i=1, Board.Size do
		for j=1, Board.Size do
			Board.Label[i*Board.Size+j] = 0
		end
	end
end


\stopluacode

\def\move#1%
	{\ctxlua{play_move("#1")}}

%\def\move
%	{\dosingleargument\domove}

%\def\domove[#1]{#2}{#3}
%	{\iffirstargument
%		\ctxlua{play_move(#2, #3, "#1")}
%	\else
%		\ctxlua{play_move(#2, #3)}
%	\fi}

\def\pass
	{\ctxlua{play_move()}}

\def\stone[#1]#2%
	{\ctxlua{set_stone("#2", "#1")}}

\def\marker#1%
	{\ctxlua{set_marker("#1")}}

\def\newboard
	{\dosingleargument\donewboard}

\def\donewboard[#1]%
	{\iffirstargument
		\ctxlua{reset_board("#1")}
	\else
		\ctxlua{reset_board("big")}
	\fi}

\def\resetnumbering
	{\ctxlua{reset_labels()}}

\def\drawboard
	{\dosingleargument\dodrawboard}

	

\def\dodrawboard[#1]%
	{\iffirstargument
		\ctxlua{display_board(0, "#1")}
	\else
		\ctxlua{display_board(0, "medium")}
	\fi}



\def\drawpartialboard#1#2%
	{\ctxlua{display_board(0, "medium", "#1", "#2")}}


\starttext

\newboard[medium]
\stone[black]{bb}
\stone[black]{cb}
\marker{cb}
\stone[black]{eb}
\stone[white]{bc}
\stone[white]{bd}
\marker{bd}
\stone[white]{dd}
\stone[white]{dc}
\stone[empty]{dd}
\stone[black]{hb}
\stone[black]{fc}
\stone[white]{ch}

\stone[black]{id}
\stone[black]{hd}
\stone[white]{gd}
\stone[white]{fb}
\stone[black]{jb}
\stone[black]{kd}
\stone[black]{jj}
\stone[white]{kh}
\drawpartialboard{gg}{mm}
\drawboard

\newboard  % [big]
\move{dp}
\move{cn}
\move{fp}
\move{bp}
\move{cq}
\move{ck}
\move{jq}
\drawboard

\pass
\move{pd}

\resetnumbering
\marker{pd}
\move{nc}
\move{qf}
\move{jd}
\drawpartialboard{da}{sh}
\drawboard

\stoptext
